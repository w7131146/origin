"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("os");var e=require("fs"),r=require("path"),t=require("./playable-adapter-core-460d0221.js"),o=require("electron");require("util"),require("stream"),require("http"),require("https"),require("url"),require("assert"),require("zlib"),require("events"),require("buffer");const i="build-finished",s="build-start",a="playable-ads-adapter",d=(r,t)=>e.readFileSync(r).toString(t),n=()=>{const r=`${Editor.Project.path}/.adapterrc`;return e.existsSync(r)?JSON.parse(d(r)):null},l=()=>{const e=Editor.Project.path,t="/build",o=n();let i=o?.buildPlatform??"web-mobile";return{projectRootPath:e,projectBuildPath:t,buildPlatform:i,originPkgPath:r.join(e,t,i),adapterBuildConfig:o}},u=()=>{const e=n();return!!e&&(e.skipBuild??!1)};var c=require("path").join(__dirname+"/2x-63d28bb1.js");const p=(e,r)=>{Editor.log(`${a} 进行预构建处理`),Editor.log(`${a} 预构建处理完成`),r&&r()},b=async(e,i)=>{Editor.info(`${a} 开始适配`);const s=(new Date).getTime(),d=()=>{const e=(new Date).getTime();Editor.success(`${a} 适配完成，共耗时${((e-s)/1e3).toFixed(0)}秒`),o.shell.openPath(b),i&&i()},{projectRootPath:n,projectBuildPath:u,adapterBuildConfig:p}=l(),b=r.join(n,u),h={buildFolderPath:b,adapterBuildConfig:{...p,buildPlatform:e.platform,orientation:e.webOrientation}};try{const{Worker:e}=require("worker_threads");console.log("支持Worker，将开启子线程适配");new e(c,{workerData:h}).on("message",(({finished:e,msg:r})=>{var t;e?d():(t=r,Editor.error("适配失败"),Editor.error(t),i&&i())}))}catch(e){console.log("不支持Worker，将开启主线程适配"),await t.exec2xAdapter(h,{mode:"serial"}),d()}},h=()=>{const{buildPlatform:e,originPkgPath:r}=l();Editor.log(`开始构建项目，导出${e}包`),Editor.Ipc.sendToMain("builder:query-build-options",((t,o)=>{const i=o.scenes||[];0===i.length&&i.push(o.startScene);const s=(()=>{const e=`${Editor.Project.path}/settings/project.json`;return JSON.parse(d(e))["excluded-modules"]||["3D Physics/Builtin"]})();let a={...o,md5Cache:!1,inlineSpriteFrames:!1,inlineSpriteFrames_native:!1,debug:!1,platform:e,actualPlatform:e,sourceMaps:!1,scenes:i,excludedModules:s,dest:r};u()?p(0,(()=>{b(a)})):Editor.Ipc.sendToMain("builder:start-task","build",a)}))};const g={"adapter-build"(){h()}};exports.load=function(){console.log(`${a} is loaded`),Editor.Builder.on(s,p),Editor.Builder.on(i,b)},exports.messages=g,exports.unload=function(){console.log(`${a} is unloaded`),Editor.Builder.removeListener(s,p),Editor.Builder.removeListener(i,b)};
